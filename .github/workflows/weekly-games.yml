name: Weekly Epic Games Collector

on:
  schedule:
    - cron: '0 0 * * 0'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 00:00 UTC
    - cron: '0 0 * * 5'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –≤ 00:00 UTC
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  # Test comment

jobs:
  collect-games:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        
    - name: Set up virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        
    - name: Install Python dependencies
      run: |
        cd epic-awesome-gamer-main
        source ../.venv/bin/activate
        pip install -e .
        if [ $? -ne 0 ]; then
          echo "Failed to install dependencies"
          exit 1
        fi
        
    - name: Run Epic Games Collector
      id: run_script
      run: |
        cd epic-awesome-gamer-main
        source ../.venv/bin/activate
        echo "Creating accounts.json..."
        echo '${{ secrets.EPIC_ACCOUNTS }}' > accounts.json
        echo "Creating .env file..."
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
        echo "Starting script..."
        echo "Python version:"
        python --version
        echo "Installed packages:"
        pip list
        echo "Running script..."
        PYTHONUNBUFFERED=1 xvfb-run python -m epic_awesome_gamer.cli.main collect 2>&1 | tee output.log
        SCRIPT_EXIT_CODE=$?
        echo "Script finished with exit code: $SCRIPT_EXIT_CODE"
        if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
          echo "Script execution failed"
          exit $SCRIPT_EXIT_CODE
        fi
        
    - name: Show output
      if: always()
      run: |
        echo "=== Script Output ==="
        LOG_FILE="epic-awesome-gamer-main/output.log"
        if [ -f "$LOG_FILE" ]; then
          echo "Output log file found: $LOG_FILE"
          echo "=== Last 100 lines of log ==="
          tail -n 100 "$LOG_FILE"
          echo "=== End of log ==="
        else
          echo "Output log file NOT found at: $LOG_FILE"
          echo "Current directory contents:"
          ls -la
        fi

    - name: Send Telegram notification
      if: always() # –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ —É–ø–∞–ª–∏
      run: |
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        WORKFLOW_NAME="${{ github.workflow }}"
        CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          MESSAGE="‚úÖ GitHub Actions Workflow —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.

üîÑ –†–∞–±–æ—Ç–∞: ${WORKFLOW_NAME}
üìÖ –î–∞—Ç–∞: ${CURRENT_DATE}
üîó –°—Å—ã–ª–∫–∞: ${RUN_URL}"
        else
          MESSAGE="‚ùå GitHub Actions Workflow –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π.

üîÑ –†–∞–±–æ—Ç–∞: ${WORKFLOW_NAME}
üìÖ –î–∞—Ç–∞: ${CURRENT_DATE}
üîó –°—Å—ã–ª–∫–∞: ${RUN_URL}"
        fi

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        TELEGRAM_API="https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage"
        CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
        
        curl -s -X POST "${TELEGRAM_API}" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=HTML" \
          -d "disable_web_page_preview=true" || {
            echo "Failed to send Telegram notification"
            exit 1
          }