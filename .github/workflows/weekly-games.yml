name: Weekly Epic Games Collector

on:
  schedule:
    - cron: '0 0 * * 0'  # Запуск каждое воскресенье в 00:00 UTC
    - cron: '0 0 * * 5'  # Запуск каждую пятницу в 00:00 UTC
  workflow_dispatch:  # Позволяет запускать вручную
  # Test comment

jobs:
  collect-games:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        
    - name: Set up virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        
    - name: Install Python dependencies
      run: |
        cd epic-awesome-gamer-main
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: Run Epic Games Collector
      id: run_script
      run: |
        cd epic-awesome-gamer-main
        echo "Creating accounts.json..."
        echo '${{ secrets.EPIC_ACCOUNTS }}' > accounts.json
        echo "Creating .env file..."
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
        echo "Starting script..."
        echo "Python version:"
        python --version
        echo "Installed packages:"
        pip list
        echo "Running script..."
        PYTHONUNBUFFERED=1 xvfb-run python -m epic_awesome_gamer.cli.main collect 2>&1 | tee output.log
        echo "Script finished with exit code: $?"
        
    - name: Show output
      if: always()
      run: |
        echo "=== Script Output ==="
        LOG_FILE="epic-awesome-gamer-main/output.log"
        if [ -f "$LOG_FILE" ]; then
          echo "Output log file found: $LOG_FILE"
          cat "$LOG_FILE"
        else:
          echo "Output log file NOT found at: $LOG_FILE"
        fi

    - name: Send Telegram notification
      if: always() # Выполнять всегда, даже если предыдущие шаги упали
      run: |
        # Определяем статус выполнения job'а
        if [[ "${{ job.status }}" == "success" ]]; then
          MESSAGE="✅ GitHub Actions Workflow успешно завершен."
        else
          MESSAGE="❌ GitHub Actions Workflow завершен с ошибкой."
        fi
        
        # Отправляем уведомление в Telegram
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} -d text="$MESSAGE" -d parse_mode="HTML"