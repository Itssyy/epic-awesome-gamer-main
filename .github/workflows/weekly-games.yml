name: Weekly Epic Games Collector

on:
  schedule:
    - cron: '0 0 * * 0'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 00:00 UTC
    - cron: '0 0 * * 5'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –≤ 00:00 UTC
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  # Test comment

jobs:
  collect-games:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        
    - name: Set up virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        
    - name: Install Python dependencies
      run: |
        cd epic-awesome-gamer-main
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: Run Epic Games Collector
      id: run_script
      run: |
        cd epic-awesome-gamer-main
        echo "Creating accounts.json..."
        echo '${{ secrets.EPIC_ACCOUNTS }}' > accounts.json
        echo "Creating .env file..."
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
        echo "Starting script..."
        echo "Python version:"
        python --version
        echo "Installed packages:"
        pip list
        echo "Running script..."
        PYTHONUNBUFFERED=1 xvfb-run python -u src/epic_awesome_gamer/epic_games.py 2>&1 | tee output.log
        echo "Script finished with exit code: $?"
        
    - name: Show output
      if: always()
      run: |
        echo "=== Script Output ==="
        LOG_FILE="epic-awesome-gamer-main/output.log"
        if [ -f "$LOG_FILE" ]; then
          echo "Output log file found: $LOG_FILE"
          cat "$LOG_FILE"
        else
          echo "Output log file NOT found at: $LOG_FILE"
        fi
        
    - name: Send Telegram notification
      if: always()
      run: |
        python -c "
        import requests
        import os
        from datetime import datetime
        
        # –ß–∏—Ç–∞–µ–º –ª–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        log_path = 'epic-awesome-gamer-main/output.log'
        if os.path.exists(log_path):
            with open(log_path, 'r') as f:
                output = f.read()
        else:
            output = 'No output log file found!'
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        status = '‚úÖ –£—Å–ø–µ—à–Ω–æ' if '${{ job.status }}' == 'success' else '‚ùå –û—à–∏–±–∫–∞'
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        message = f'''üéÆ Epic Games Collector
        –í—Ä–µ–º—è: {current_time}
        –°—Ç–∞—Ç—É—Å: {status}
        
        –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
        {output}'''
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        telegram_token = '${{ secrets.TELEGRAM_BOT_TOKEN }}'
        telegram_chat_id = '${{ secrets.TELEGRAM_CHAT_ID }}'
        
        url = f'https://api.telegram.org/bot{telegram_token}/sendMessage'
        data = {
            'chat_id': telegram_chat_id,
            'text': message,
            'parse_mode': 'HTML'
        }
        
        requests.post(url, data=data)
        " 